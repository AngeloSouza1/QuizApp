<div class="container mt-5">
  <h1 class="text-center text-secondary-dark mb-4"><%= @quiz.title %></h1>
  <p class="text-center text-muted mb-5" style="font-size: 1.2rem;"><%= @quiz.description %></p>

  <% if @questions.present? %>
    <%= form_with(url: answer_quiz_path(@quiz), method: :post, local: true, id: 'quiz-form') do %>

      <!-- Carrossel -->
      <div id="quizCarousel" class="carousel slide" data-ride="carousel" data-interval="false">
        <div class="carousel-inner">

          <% @questions.each_with_index do |question, index| %>
            <div class="carousel-item <%= 'active' if index == 0 %>">
              <div class="question text-center">
                <h3 class="text-center mb-4"><%= "#{index + 1}. #{question.content}" %></h3>
                <div class="answers mt-4">
                  <% question.answers.each do |answer| %>
                    <div class="form-check d-flex align-items-center justify-content-center mb-3">
                      <div class="form-check-label-container" style="display: inline-block; width: auto;">
                        <%= radio_button_tag "responses[#{question.id}]", answer.id, false, id: "answer_#{question.id}_#{answer.id}", class: "form-check-input" %>
                        <%= label_tag "answer_#{question.id}_#{answer.id}", answer.content, class: "form-check-label ml-2", style: "vertical-align: middle; font-size: 1.3rem;" %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>

        </div>

        <!-- Controles do Carrossel -->
        <a class="carousel-control-prev" href="#quizCarousel" role="button" data-slide="prev">
          <span class="carousel-control-prev-icon dark-arrow" aria-hidden="true"></span>
          <span class="sr-only">Anterior</span>
        </a>
        <a class="carousel-control-next" href="#quizCarousel" role="button" data-slide="next">
          <span class="carousel-control-next-icon dark-arrow" aria-hidden="true"></span>
          <span class="sr-only">Próximo</span>
        </a>
      </div>

      <div class="text-center mt-4">
        <%= submit_tag 'Enviar Respostas', class: 'btn btn-success btn-lg', id: 'submit-button', disabled: true %>
        <%= link_to 'Voltar para Quizzes', quizzes_path, class: 'btn btn-secondary btn-lg ml-2' %>
      </div>
    <% end %>
  <% else %>
    <p class="text-danger text-center">Esse quiz não possui perguntas ainda.</p>
  <% end %>
</div>

<style>
  .carousel-item {
    transition: transform 0.5s ease-in-out;
    height: auto;
  }

  .form-check {
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .form-check-input {
    margin-right: 10px;
  }

  .form-check-label-container {
    display: flex;
    align-items: center;
  }

  .form-check-label {
    margin-left: 10px;
    text-align: left;
    font-size: 1.4rem;
  }

  .question {
    margin: 20px 0;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .dark-arrow {
    background-color: rgba(0, 0, 0, 0.7);
    border-radius: 50%;
    width: 45px;
    height: 45px;
  }

  .carousel-control-prev-icon, .carousel-control-next-icon {
    filter: invert(100%);
  }

  .text-secondary-dark {
    color: #204a80;
  }
</style>

<script>
  function checkAllAnswered() {
    const totalQuestions = document.querySelectorAll('.carousel-item').length;
    const answeredQuestions = document.querySelectorAll('.form-check-input:checked').length;
    const submitButton = document.getElementById('submit-button');

    if (answeredQuestions === totalQuestions) {
      submitButton.disabled = false;
    } else {
      submitButton.disabled = true;
    }
  }

  function handleSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    fetch(form.action, {
      method: form.method,
      body: formData,
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      }
    }).then(response => {
      if (response.ok) {
        alert('Quiz respondido com sucesso!');
        window.location.href = "<%= user_dashboard_path %>";
      } else {
        alert('Houve um erro ao enviar suas respostas. Tente novamente.');
      }
    });
  }

  document.querySelectorAll('.form-check-input').forEach(input => {
    input.addEventListener('change', checkAllAnswered);
  });

  document.getElementById('quiz-form').addEventListener('submit', handleSubmit);
</script>
